<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suwayda Incidents – Interactive Video Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; }
    .app { display: grid; grid-template-columns: 340px 1fr; grid-template-rows: 64px 1fr; height: 100%; }
    header { grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between; padding: 10px 14px; border-bottom: 1px solid #e5e7eb; gap: 10px; }
    header h1 { font-size: 18px; margin: 0; }
    #sidebar { border-right: 1px solid #e5e7eb; padding: 12px; overflow:auto; }
    #map { width: 100%; height: 100%; position: relative; }

    .actions { display:flex; flex-wrap: wrap; gap:8px; align-items:center; }
    .field { margin-bottom: 10px; }
    label { font-size: 13px; color: #111827; display:block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; }
    .chip { padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; font-size:12px; cursor:pointer; }
    .chip.active { background:#111827; color:white; border-color:#111827; }

    .legend { font-size: 12px; line-height:1.4; }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }

    .popup { width: 320px; }
    .popup h3 { margin: 0 0 8px; font-size: 14px; }
    .meta { font-size: 12px; color: #4b5563; margin-bottom: 8px; }
    .thumb-wrap { position: relative; border-radius: 10px; overflow: hidden; background:#000; }
    .thumb-wrap video, .thumb-wrap img { display:block; width:100%; height:auto; }
    .badge { position:absolute; top:8px; left:8px; background:rgba(17,24,39,.9); color:#fff; font-size:11px; padding:4px 6px; border-radius:6px; }
    .consent { margin-top:8px; font-size:11px; color:#6b7280; }

    .footer { font-size: 12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding: 8px 10px; border-radius: 10px; border:1px solid #d1d5db; background:white; cursor:pointer; font-size: 13px; }
    .btn:hover { background:#f9fafb; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }

    /* Admin panel */
    #adminPanel { position:absolute; right:16px; top:80px; width:360px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:12px; display:none; z-index:5000; }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Suwayda Incidents – Interactive Video Map</h1>
    <div class="actions">
      <input id="dataUrl" style="min-width:280px" placeholder="https://example.org/incidents.json" />
      <button id="fetchBtn" class="btn">Fetch JSON</button>
      <input id="dataFile" type="file" accept="application/json" style="display:none" />
      <button id="uploadBtn" class="btn">Load JSON file…</button>
      <button id="fitBtn" class="btn">Fit to Results</button>
      <button id="resetBtn" class="btn">Reset Filters</button>
      <button id="adminBtn" class="btn">Admin: Add incident</button>
    </div>
  </header>

  <aside id="sidebar">
    <div class="field">
      <label for="q">Search (title/notes)</label>
      <input id="q" type="search" placeholder="e.g., checkpoint, aid, shelling" />
    </div>

    <div class="field">
      <label>Date range</label>
      <div style="display:flex; gap:8px">
        <input id="from" type="date" />
        <input id="to" type="date" />
      </div>
    </div>

    <div class="field">
      <label>Incident types</label>
      <div id="typeChips" class="chips"></div>
    </div>

    <div class="field legend">
      <div class="row"><span class="dot" style="background:#ef4444"></span> Violence / Executions</div>
      <div class="row"><span class="dot" style="background:#3b82f6"></span> Siege / Aid denial</div>
      <div class="row"><span class="dot" style="background:#f59e0b"></span> Detention / Abduction</div>
      <div class="row"><span class="dot" style="background:#10b981"></span> Protest / Demonstration</div>
    </div>

    <div class="footer">
      <p><strong>Safety:</strong> Videos should be redacted and metadata removed. Originals stored securely.</p>
    </div>
  </aside>

  <main id="map">
    <!-- Admin Panel -->
    <div id="adminPanel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
        <strong>Admin – Add Incident</strong>
        <button id="closeAdmin" class="btn">Close</button>
      </div>

      <div class="field"><label>Click on the map to set location</label>
        <div id="adminCoords" style="font-size:12px;color:#6b7280">lat: —, lng: —</div>
      </div>

      <div class="field"><label>Title</label><input id="a_title" placeholder="Short description"/></div>
      <div class="field"><label>Type</label>
        <select id="a_type">
          <option value="violence">Violence / Executions</option>
          <option value="siege">Siege / Aid denial</option>
          <option value="detention">Detention / Abduction</option>
          <option value="protest">Protest / Demonstration</option>
        </select>
      </div>
      <div class="field"><label>Date</label><input id="a_date" type="date"/></div>
      <div class="field"><label>Video URL</label><input id="a_video" placeholder="videos/clip.mp4 or https://..."/></div>
      <div class="field"><label>Source (optional)</label><input id="a_source" placeholder="e.g., tg:@username"/></div>
      <div class="field"><label>Consent</label>
        <select id="a_consent"><option>public</option><option>press</option><option>private</option></select>
      </div>
      <div class="field"><label>Notes (optional)</label><input id="a_notes" placeholder="Faces blurred, etc."/></div>

      <div style="display:flex; gap:8px;">
        <button id="a_save" class="btn primary">Save to Map</button>
        <button id="a_download" class="btn">Download JSON</button>
      </div>
    </div>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- hls.js (only needed if you use .m3u8) -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

<script>
// --- CONFIG ---
const TYPE_META = {
  violence:  { label: 'Violence / Executions', color: '#ef4444' },
  siege:     { label: 'Siege / Aid denial',   color: '#3b82f6' },
  detention: { label: 'Detention / Abduction',color: '#f59e0b' },
  protest:   { label: 'Protest / Demonstration', color: '#10b981' },
};

// DATA SCHEMA (JSON array):
// [
//   {
//     "id": "SWA-001",
//     "title": "...",
//     "type": "violence|siege|detention|protest",
//     "lat": 32.709, "lng": 36.568,
//     "date": "2025-08-03",
//     "videoUrl": "videos/clip.mp4" or "https://...mp4" or ".m3u8",
//     "thumb": "https://...jpg",
//     "source": "Witness A",
//     "consent": "public|press|private",
//     "notes": "Faces blurred..."
//   }
// ]

// Start with a tiny inline sample (safe to delete)
let INCIDENTS = [
  {
    id: 'SWA-001',
    title: 'Sample incident (replace or load incidents.json)',
    type: 'violence',
    lat: 32.709, lng: 36.568,
    date: '2025-08-03',
    videoUrl: 'videos/sample.mp4',
    source: 'demo',
    consent: 'public',
    notes: 'This is a placeholder.'
  }
];

// --- MAP INIT ---
const map = L.map('map', { zoomControl: true, attributionControl: true }).setView([32.709, 36.568], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

// Optional clustering (recommended for many points)
const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 15, spiderfyOnMaxZoom: true, showCoverageOnHover: false });
map.addLayer(cluster);

// Build type chips
const typeChipsEl = document.getElementById('typeChips');
const activeTypes = new Set(Object.keys(TYPE_META));
for (const [key, meta] of Object.entries(TYPE_META)) {
  const chip = document.createElement('button');
  chip.className = 'chip active';
  chip.textContent = meta.label;
  chip.style.borderColor = meta.color;
  chip.onclick = () => { if (activeTypes.has(key)) { activeTypes.delete(key); chip.classList.remove('active'); } else { activeTypes.add(key); chip.classList.add('active'); } applyFilters(); };
  typeChipsEl.appendChild(chip);
}

// UI controls
const qEl = document.getElementById('q');
const fromEl = document.getElementById('from');
const toEl = document.getElementById('to');
const fitBtn = document.getElementById('fitBtn');
const resetBtn = document.getElementById('resetBtn');
qEl.addEventListener('input', applyFilters);
fromEl.addEventListener('change', applyFilters);
toEl.addEventListener('change', applyFilters);
fitBtn.addEventListener('click', fitToResults);
resetBtn.addEventListener('click', () => {
  qEl.value = ''; fromEl.value = ''; toEl.value = '';
  activeTypes.clear(); Object.keys(TYPE_META).forEach(t => activeTypes.add(t));
  Array.from(typeChipsEl.children).forEach(c => c.classList.add('active'));
  applyFilters();
});

// Data import controls
const uploadBtn = document.getElementById('uploadBtn');
const dataFile = document.getElementById('dataFile');
const dataUrl = document.getElementById('dataUrl');
const fetchBtn = document.getElementById('fetchBtn');
uploadBtn.addEventListener('click', () => dataFile.click());
dataFile.addEventListener('change', async (e) => {
  const file = e.target.files[0]; if (!file) return;
  try { const text = await file.text(); const json = JSON.parse(text); setIncidents(json); }
  catch (err) { alert('Invalid JSON: ' + err.message); }
});
fetchBtn.addEventListener('click', async () => {
  if (!dataUrl.value) return alert('Enter a JSON URL');
  try {
    const res = await fetch(dataUrl.value, { cache: 'no-store' });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const json = await res.json();
    setIncidents(json);
  } catch (err) {
    alert('Fetch failed: ' + err.message + '\n(If hosted on S3/Cloudflare, ensure CORS allows GET from your site.)');
  }
});

// Try to auto-load ./incidents.json if present (for GitHub Pages)
(async function tryLoadDefaultJSON(){
  try {
    const res = await fetch('./incidents.json?cb=' + Date.now(), {cache:'no-store'});
    if (res.ok) {
      const json = await res.json();
      setIncidents(json);
      console.log('Loaded incidents.json');
    } else {
      console.log('incidents.json not found (using inline sample)');
    }
  } catch (e) {
    console.log('No incidents.json (using inline sample)');
  }
})();

// Markers registry
let allMarkers = [];

function setIncidents(arr) {
  if (!Array.isArray(arr)) throw new Error('Root must be an array');
  for (const o of arr) {
    if (typeof o.id !== 'string') throw new Error('Missing id');
    if (typeof o.title !== 'string') throw new Error('Missing title');
    if (typeof o.lat !== 'number' || typeof o.lng !== 'number') throw new Error('lat/lng must be numbers');
    if (typeof o.date !== 'string') throw new Error('date must be YYYY-MM-DD string');
    if (!o.videoUrl || typeof o.videoUrl !== 'string') throw new Error('videoUrl is required');
  }
  INCIDENTS = arr;
  cluster.clearLayers();
  allMarkers = [];
  for (const inc of INCIDENTS) { allMarkers.push(makeMarker(inc)); }
  applyFilters();
  fitToResults();
}

function makeMarker(inc) {
  const meta = TYPE_META[inc.type] || { color: '#111827', label: inc.type || 'Other' };
  const icon = L.divIcon({ className: 'custom-marker', html: `<div style="width:14px;height:14px;border-radius:50%;background:${meta.color};box-shadow:0 0 0 2px white, 0 0 0 3px ${meta.color}66"></div>` });
  const m = L.marker([inc.lat, inc.lng], { icon });
  m.incident = inc;
  m.bindPopup(buildPopupHTML(inc), { maxWidth: 360 });
  m.on('popupopen', (e) => {
    const root = e.popup.getElement();
    const vid = root.querySelector('video');
    if (vid) {
      if (vid.dataset.hls === '1' && window.Hls && window.Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(vid.dataset.src);
        hls.attachMedia(vid);
        hls.on(Hls.Events.MANIFEST_PARSED, () => vid.play().catch(()=>{}));
      } else { vid.play().catch(()=>{}); }
    }
  });
  m.on('popupclose', (e) => { const vid = e.popup.getElement().querySelector('video'); if (vid) vid.pause(); });
  return m;
}

function buildPopupHTML(inc) {
  const meta = TYPE_META[inc.type] || { label: inc.type || 'Other' };
  const isHLS = inc.videoUrl && inc.videoUrl.endsWith('.m3u8');
  const videoAttrs = `playsinline muted controls preload="metadata" style="width:100%;height:auto;border-radius:10px;"`;
  const media = inc.videoUrl
    ? (isHLS ? `<video data-hls="1" data-src="${inc.videoUrl}" ${videoAttrs}></video>`
             : `<video src="${inc.videoUrl}" ${videoAttrs}></video>`)
    : (inc.thumb ? `<img src="${inc.thumb}" alt="thumbnail"/>` : '');
  return `
    <div class="popup">
      <h3>${escapeHTML(inc.title)}</h3>
      <div class="meta">${inc.date} · <span style="color:${(TYPE_META[inc.type]||{}).color}">${meta.label}</span></div>
      <div class="thumb-wrap">
        ${inc.id ? `<span class="badge">${inc.id}</span>` : ''}
        ${media}
      </div>
      <div class="meta" style="margin-top:8px">Source: ${escapeHTML(inc.source||'—')} · Consent: ${inc.consent||'—'}</div>
      ${inc.notes ? `<div class="consent">${escapeHTML(inc.notes)}</div>` : ''}
    </div>`;
}

function escapeHTML(str='') { return str.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }

function applyFilters() {
  const q = qEl.value.trim().toLowerCase();
  const from = fromEl.value ? new Date(fromEl.value) : null;
  const to = toEl.value ? new Date(toEl.value) : null;
  cluster.clearLayers();
  const visible = [];
  for (const m of allMarkers) {
    const inc = m.incident; const d = new Date(inc.date);
    const matchesType = activeTypes.has(inc.type);
    const matchesText = !q || (inc.title + ' ' + (inc.notes||'')).toLowerCase().includes(q);
    const afterFrom = !from || d >= from; const beforeTo = !to || d <= to;
    const ok = matchesType && matchesText && afterFrom && beforeTo;
    if (ok) { cluster.addLayer(m); visible.push(m); }
  }
  fitBtn.disabled = visible.length === 0;
}

function fitToResults() { const b = cluster.getBounds(); if (b && b.isValid()) map.fitBounds(b.pad(0.2)); }

// --- Admin tools ---
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const closeAdmin = document.getElementById('closeAdmin');
const adminCoords = document.getElementById('adminCoords');
const a_title = document.getElementById('a_title');
const a_type = document.getElementById('a_type');
const a_date = document.getElementById('a_date');
const a_video = document.getElementById('a_video');
const a_source = document.getElementById('a_source');
const a_consent = document.getElementById('a_consent');
const a_notes = document.getElementById('a_notes');
const a_save = document.getElementById('a_save');
const a_download = document.getElementById('a_download');

try { a_date.valueAsDate = new Date(); } catch(e) {}

let adminActive = false;
let adminTempMarker = null;
adminBtn.addEventListener('click', () => { adminActive = true; adminPanel.style.display = 'block'; });
closeAdmin.addEventListener('click', () => { adminActive = false; adminPanel.style.display = 'none'; if (adminTempMarker) { map.removeLayer(adminTempMarker); adminTempMarker=null; } adminCoords.textContent='lat: —, lng: —'; });

map.on('click', (e) => {
  if (!adminActive) return;
  const { lat, lng } = e.latlng;
  adminCoords.textContent = `lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`;
  if (!adminTempMarker) { adminTempMarker = L.marker([lat, lng]).addTo(map); }
  else { adminTempMarker.setLatLng([lat, lng]); }
});

a_save.addEventListener('click', () => {
  if (!adminTempMarker) return alert('Click on the map to set location');
  if (!a_title.value.trim()) return alert('Title is required');
  if (!a_video.value.trim()) return alert('Video URL is required');
  const { lat, lng } = adminTempMarker.getLatLng();
  const inc = {
    id: `SWA-${Math.random().toString(36).slice(2,8).toUpperCase()}`,
    title: a_title.value.trim(),
    type: a_type.value,
    lat: +lat.toFixed(6), lng: +lng.toFixed(6),
    date: a_date.value || new Date().toISOString().slice(0,10),
    videoUrl: a_video.value.trim(),
    source: a_source.value.trim() || undefined,
    consent: a_consent.value,
    notes: a_notes.value.trim() || undefined
  };
  INCIDENTS.push(inc);
  const m = makeMarker(inc); allMarkers.push(m); applyFilters();
  alert('Added to map (not saved to server). Use "Download JSON" to export.');
});

a_download.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(INCIDENTS, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'incidents.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// Initialize markers from the inline sample (will be replaced if incidents.json loads)
let allMarkers = [];
for (const inc of INCIDENTS) { allMarkers.push(makeMarker(inc)); }
applyFilters();
fitToResults();
</script>
</body>
</html>
